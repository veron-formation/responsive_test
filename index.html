<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carrousel Dynamique avec Filtre de Vérification</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        /* -------------------------------------------------------------------
            1. STYLES GÉNÉRAUX DU CARROUSEL (HTML CLASS: .temoignages-conteneur)
            ------------------------------------------------------------------- */
        .temoignages-conteneur {
            font-family: 'Poppins', sans-serif; 
            display: flex;
            flex-wrap: nowrap;
            align-items: stretch; 
            min-height: 450px; 
            overflow-x: scroll;
            -ms-overflow-style: none;
            scrollbar-width: none;
            gap: 30px; 
            padding: 10px 0; 
            margin: 0 auto;
        }
        .temoignages-conteneur::-webkit-scrollbar {
            display: none;
        }

        /* -------------------------------------------------------------------
            2. STYLES DE LA VIGNETTE (HTML CLASS: .vignette-avis)
            ------------------------------------------------------------------- */
        .vignette-avis {
            background-color: #f7f7f7;
            padding: 15px;	
            border-radius: 8px;	
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: left;	
            
            flex: 0 0 30% !important;	
            min-width: 300px !important;	

            display: flex;	
            flex-direction: column;
            justify-content: space-between !important;	

            flex-grow: 1;	
            box-sizing: border-box;
            height: auto;	
        }

        /* Style spécifique du bloc de commentaire */
        .texte-avis.commentaire-principal {
            flex-grow: 1;	
            text-align: left;	
            
            margin-top: 0px;	
            padding-top: 0px;
            border-top: none;	
            font-style: normal;
            font-size: 1em; 
            line-height: 1.5; 
            
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* -------------------------------------------------------------------
            3. STYLES SPÉCIFIQUES À LA VIGNETTE & NOUVELLE MISE EN PAGE
            ------------------------------------------------------------------- */
        
        /* Organisation de l'en-tête (Nom/Fonction vs Icônes) */
        .avis-header {
            display: block;
            margin-bottom: 5px; 
        }
        
        /* CORRECTION CLÉ : Flotter les icônes à droite, au-dessus du Nom/Fonction */
        .icones-top-right {
            display: flex;
            gap: 8px; 
            align-items: center; 
            
            float: right;
            margin-bottom: 5px; 
        }
        
        /* Assurer que les images sont bien traitées et agrandies */
        .icone-verifie img,
        .icone-linkedin-lien img {
            transition: none;
            display: block;	
            width: 24px !important;
            height: 24px !important;
        }

        /* Conteneur des informations du client (Nom/Fonction) */
        .client-info-bloc {
            margin-bottom: 0px;	
            overflow: hidden; 
        }

        .client-nom {
            font-weight: 600; 
            font-size: 1.20em; 
            color: #333;	
            margin-bottom: 0px;	
        }

        .client-fonction {
            font-size: 0.95em; 
            color: #6c757d;	
            margin-top: 2px;
            margin-bottom: 2px; 
        }

        /* Conteneur des étoiles */
        .evaluation-etoiles {
            margin-bottom: 2px;	
            margin-top: 2px; 
            text-align: left;	
            color: #ffc107;	
            font-size: 1.4em;
        }
        
        .client-linkedin-lien {
            display: none !important;	
        }

        /* Style de l'icône de vérification */
        .icone-verifie {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* -------------------------------------------------------------------
            4. STYLES DE NAVIGATION & STATISTIQUES (EN-TÊTE)
            ------------------------------------------------------------------- */
        
        .widget-global-conteneur {
            max-width: 100%; 
            padding: 0 20px; 
            margin: 0 auto;
        }
        
        .statistiques-navigation-header {
            display: flex;
            justify-content: center; 
            align-items: center;
            padding: 5px 0; 
            margin-bottom: 10px;
            font-family: 'poppins', sans-serif; 
        }

        .statistiques-conteneur {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            font-size: 1.1em;
            font-weight: 500;
        }

        /* NOUVEAU STYLE : Étoile à côté du 5.0 */
        .etoile-stats {
            color: #ffc107; 
            font-size: 0.9em; 
            margin-left: 2px;
        }

        .valeur-moyenne {
            font-weight: 700;
            font-size: 1.6em; 
            color: #333; 
        }

        .valeur-total {
            font-weight: 700;
            font-size: 1.6em; 
            color: #333; 
        }

        .texte-note, .texte-avis {
            display: block;
            font-size: 0.8em;
            color: #6c757d;
            margin-top: -3px;
        }

        .separateur {
            height: 40px;
            width: 1px;
            background-color: #ddd;
        }
        
        /* Flèches */
        .fleche-header {
            position: static; 
            transform: none;
            margin: 0 20px;
            background-color: #008060; 
            color: white;
            border: none;
            box-shadow: none;
            width: 40px;          
            height: 40px;         
            font-size: 18px;      
            border-radius: 8px;   
            display: flex;        
            justify-content: center; 
            align-items: center;  
        }
        .fleche-header:hover {
            background-color: #00664c;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* Cacher l'ancien conteneur de navigation */
        .carrousel-navigation-conteneur {
            display: none;
        }

        /* -------------------------------------------------------------------
            5. MEDIA QUERY (Mobile)
            ------------------------------------------------------------------- */
        
        @media (max-width: 768px) {
            .vignette-avis {
                flex: 0 0 85% !important;
                min-width: 0 !important; 
            }
            .fleche-navigation {
                display: none;
            }
            .temoignages-conteneur {
                padding-left: 15px;
                padding-right: 15px;
                gap: 20px;
            }
            .fleche-header {
                display: none;
            }
            .widget-global-conteneur {
                padding: 0 10px; 
            }
        }

        @media (max-width: 480px) {
            .temoignages-conteneur {
                padding-left: 10px;
                padding-right: 10px;
                gap: 15px;	
            }
            .vignette-avis {
                flex: 0 0 90% !important;	
                padding: 10px;
            }
            .statistiques-conteneur {
                font-size: 0.9em; 
            }
            .valeur-moyenne, .valeur-total {
                font-size: 1.4em;
            }
        }
    </style>
</head>
<body>

    <div class="widget-global-conteneur">
        
        <div class="statistiques-navigation-header">
            
            <button id="fleche-gauche" class="fleche-navigation fleche-header" aria-label="Défiler à gauche">
                &#10094;
            </button>

            <div class="statistiques-conteneur">
                <div class="note-moyenne">
                    <span class="valeur-moyenne" id="note-moyenne-valeur">...</span>
                    <span class="texte-note">Note moyenne</span>
                </div>
                <div class="separateur"></div>
                <div class="total-avis">
                    <span class="valeur-total" id="total-avis-valeur">...</span>
                    <span class="texte-avis">Avis Total</span>
                </div>
            </div>

            <button id="fleche-droite" class="fleche-navigation fleche-header" aria-label="Défiler à droite">
                &#10095;
            </button>

        </div>
        
        <div class="carrousel-seul-conteneur">
            <section class="temoignages-conteneur">	
                </section>
        </div>

    </div>


    <script>
        // ⚠️ VOS VARIABLES D'API (A CONSERVER TELLES QUELLES SI ELLES FONCTIONNENT)
        const API_KEY = 'AIzaSyA5ltEx_jUIlgC-IrGsubOfKQIHFyg4u78';
        const SPREADSHEET_ID = '14HcunSAnIfklpemWokAvHl7H_o1yipDbWsQ2k5TE_KY';
        const SHEET_NAME = 'Réponses au formulaire 1';
        
        // URLS D'ICÔNES
        const LINKEDIN_ICON_URL = "https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png";
        const CHECK_ICON_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/Check_icon.png/640px-Check_icon.png";

        const RANGE = `${SHEET_NAME}!A2:G`; 
        const API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        
        const conteneurTemoignages = document.querySelector('.temoignages-conteneur');
        const flecheGauche = document.getElementById('fleche-gauche');
        const flecheDroite = document.getElementById('fleche-droite');


        /**
         * Convertit le texte des étoiles (par ex. 5) en entités HTML (★★★★★)
         */
        function genererEtoiles(note) {
            const noteNumerique = parseInt(note);
            let etoilesHTML = '';
            const etoilePleine = '<span class="etoile pleine">&#9733;</span>';
            // CORRECTION CLÉ DU BUG ÉTOILES
            const etoileVide = '<span class="etoile vide">&#9734;</span>'; 

            for (let i = 0; i < 5; i++) {
                etoilesHTML += (i < noteNumerique) ? etoilePleine : etoileVide;
            }
            return `<div class="evaluation-etoiles">${etoilesHTML}</div>`;
        }

        /**
         * Crée le code HTML pour une seule vignette
         */
        function creerVignetteHTML(data) {
            const prenom = data[1] || '';
            const fonction = data[2] || '';
            const evaluation = data[3] || '';
            const commentaire = data[4] || '';
            const urllinkedin = data[5] ? data[5].replace(/"/g, '') : '';
            const verifie = data[6] || ''; 
            
            if (verifie !== '1') {
                return ''; 
            }
            if (!commentaire || commentaire.length < 5) return ''; 
            
            const commentaireGuillemets = `"${commentaire}"`;
            
            // Icônes agrandies (24px)
            const verifieIcone = verifie ? `
                <span class="icone-verifie">
                    <img src="${CHECK_ICON_URL}" alt="Vérifié">
                </span>
            ` : '';

            const linkedinIcone = urllinkedin ? `
                <a href="${urllinkedin}" target="_blank" class="icone-linkedin-lien">
                    <img src="${LINKEDIN_ICON_URL}" alt="LinkedIn">
                </a>
            ` : ''; 
            
            return `
                <div class="vignette-avis">
                    
                    <div class="icones-top-right">
                        ${linkedinIcone}
                        ${verifieIcone}
                    </div>

                    <div class="avis-header">
                        <div class="client-info-bloc info-top">
                            <p class="client-nom">${prenom}</p>
                            <p class="client-fonction">${fonction}</p>
                        </div>
                    </div>

                    ${genererEtoiles(evaluation)}
                    
                    <p class="texte-avis commentaire-principal">${commentaireGuillemets}</p>
                </div>
            `;
        }

        /**
         * Calcule la distance de défilement (largeur de la vignette + espace)
         */
        function calculerDistanceDefilement() {
            const vignette = conteneurTemoignages.querySelector('.vignette-avis');
            if (!vignette) return 0;
            
            const vignetteLargeur = vignette.offsetWidth;
            const gap = parseFloat(window.getComputedStyle(conteneurTemoignages).gap);
            
            return vignetteLargeur + gap; 
        }

        /**
         * Met à jour la note moyenne et le total dans l'en-tête HTML
         */
        function mettreAJourStatistiques(moyenne, total) {
            const conteneurStats = document.getElementById('note-moyenne-valeur');
            const conteneurTotal = document.getElementById('total-avis-valeur');
            
            if (conteneurStats) {
                // Ajout de l'étoile
                conteneurStats.innerHTML = `${moyenne} <span class="etoile-stats">&#9733;</span>`; 
            }
            if (conteneurTotal) {
                conteneurTotal.textContent = total;
            }
        }


        /**
         * Fonction principale pour récupérer et afficher les avis via l'API
         */
        async function chargerAvis() {
            try {
                const reponse = await fetch(API_URL);
                
                if (!reponse.ok) {
                    throw new Error(`API Google Sheets: ${reponse.status}`);
                }

                const data = await reponse.json();
                const donneesAvis = data.values || [];
                
                let sommeNotes = 0;
                let avisValides = 0;
                
                donneesAvis.forEach(avis => {
                    const note = parseInt(avis[3]); 
                    const verifie = avis[6];
                    
                    if (verifie === '1' && !isNaN(note) && avis[4] && avis[4].length > 5) {
                        sommeNotes += note;
                        avisValides++;
                    }
                });
                
                const noteMoyenne = (avisValides > 0) ? (sommeNotes / avisValides).toFixed(1) : '0.0';
                

                if (avisValides === 0) {
                     mettreAJourStatistiques('0.0', 0);
                     conteneurTemoignages.innerHTML = `<p style="text-align: center; padding: 50px;">Aucun avis vérifié trouvé dans la feuille.</p>`;
                     return;
                }
                
                const donneesAvisAffichees = donneesAvis.filter(avis => avis[6] === '1');

                const toutHTML = donneesAvisAffichees.map(creerVignetteHTML).join('');
                conteneurTemoignages.innerHTML = toutHTML;
                
                mettreAJourStatistiques(noteMoyenne, avisValides);
                activerNavigation();

            } catch (erreur) {
                console.error("Erreur lors du chargement des avis :", erreur);
                document.querySelector('.statistiques-conteneur').innerHTML = `<p>Erreur</p>`;
                conteneurTemoignages.innerHTML = `<p style="text-align: center; padding: 50px;">Désolé, impossible de charger les avis. Erreur : ${erreur.message}</p>`;
            }
        }
        
        /**
         * Active les événements de clic sur les flèches
         */
        function activerNavigation() {
             if (flecheDroite && flecheGauche) {
                flecheDroite.addEventListener('click', () => {
                    const distance = calculerDistanceDefilement();
                    conteneurTemoignages.scrollBy({
                        left: distance,
                        behavior: 'smooth' 
                    });
                });

                flecheGauche.addEventListener('click', () => {
                    const distance = calculerDistanceDefilement();
                    conteneurTemoignages.scrollBy({
                        left: -distance,
                        behavior: 'smooth'
                    });
                });
            }
        }

        // Lance le chargement des avis au chargement de la page
        chargerAvis();

    </script>

</body>
</html>





